name: AI Lighthouse Remediation

on:
  workflow_run:
    workflows: ["CI ‚Äî Build, Test & Lighthouse"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-remediate:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Download Lighthouse artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ github.event.workflow_run.id }}
          name: lighthouse-report
          path: .lighthouseci

      - name: Analyze and Auto-Fix with AI
        uses: actions/github-script@v7
        env:
          GH_MODELS_TOKEN: ${{ secrets.GH_MODELS_TOKEN }} 
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const lighthouseDir = '.lighthouseci';
            if (!fs.existsSync(lighthouseDir)) return console.log('Lighthouse directory not found.');
            
            const manifests = fs.readdirSync(lighthouseDir).filter(f => f.endsWith('.json') && f.startsWith('lhr-'));
            if (manifests.length === 0) return console.log('No Lighthouse report found.');
            
            const report = JSON.parse(fs.readFileSync(path.join(lighthouseDir, manifests[manifests.length - 1]), 'utf8'));
            
            // Filter for accessibility and performance issues
            const failedAudits = Object.values(report.audits)
              .filter(a => a.score !== null && a.score < 0.9)
              .map(a => ({
                id: a.id,
                title: a.title,
                failingElements: a.details?.items?.map(i => i.node?.snippet).filter(Boolean) || []
              }))
              .filter(a => a.failingElements.length > 0);

            if (failedAudits.length === 0) return console.log('No actionable fixes found.');
            
            if (!process.env.GH_MODELS_TOKEN) {
              throw new Error('GH_MODELS_TOKEN secret is missing!');
            }

            const prompt = `You are an expert web developer. Fix these Lighthouse issues: ${JSON.stringify(failedAudits)}. 
            For each issue, identify the file and provide a search/replace pair.
            Return a JSON object: {"fixes": [{"file": "path/to/file", "search": "old code", "replace": "new code"}]}`;
            
            try {
              // Calling GitHub Models API (hosted on Azure)
              const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: { 
                  'Authorization': `Bearer ${process.env.GH_MODELS_TOKEN}`, 
                  'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ 
                  model: 'gpt-4o',
                  messages: [{ role: 'user', content: prompt }],
                  temperature: 0.1
                })
              });

              if (!response.ok) {
                let errorBody = '';
                try {
                  errorBody = await response.text();
                } catch (e) {
                  errorBody = '<unable to read error body>';
                }
                throw new Error(`Models API request failed with status ${response.status}: ${errorBody}`);
              }
              
              const aiResult = await response.json();
              if (aiResult.error) throw new Error(aiResult.error.message);

              if (
                !aiResult ||
                !Array.isArray(aiResult.choices) ||
                aiResult.choices.length === 0 ||
                !aiResult.choices[0].message ||
                typeof aiResult.choices[0].message.content !== 'string'
              ) {
                throw new Error('Unexpected AI response structure: missing choices[0].message.content.');
              }
              const responseText = aiResult.choices[0].message.content;
              
              // Extract the first JSON object from the AI response (works even if wrapped in markdown code fences)
              const jsonMatch = responseText.match(/\{[\s\S]*\}/);
              if (!jsonMatch) throw new Error('AI response did not contain a valid JSON object.');
              
              const parsedResponse = JSON.parse(jsonMatch[0]);
              const fixes = Array.isArray(parsedResponse.fixes) ? parsedResponse.fixes : [];
              
              fixes.forEach(fix => {
                const filePath = path.join(process.env.GITHUB_WORKSPACE, fix.file);
                if (fs.existsSync(filePath)) {
                  let content = fs.readFileSync(filePath, 'utf8');
                  const occurrences = fix.search ? content.split(fix.search).length - 1 : 0;
                  if (occurrences === 0) {
                    console.log(`‚ö†Ô∏è Search string not found in ${fix.file}. AI suggested: ${fix.search}`);
                  } else if (occurrences === 1) {
                    content = content.replace(fix.search, fix.replace);
                    fs.writeFileSync(filePath, content);
                    console.log(`‚úÖ Fixed: ${fix.file}`);
                  } else {
                    console.log(`‚ö†Ô∏è Search string occurred ${occurrences} times in ${fix.file}. Skipping to avoid ambiguous fix. AI suggested: ${fix.search}`);
                  }
                } else {
                  console.log(`‚ö†Ô∏è File not found: ${fix.file}`);
                }
              });
            } catch (error) {
              console.error('AI remediation failed:', error);
            }
            
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: automated AI Lighthouse remediation"
          title: "ü§ñ Auto-fix Lighthouse Issues"
          body: "This PR contains automated fixes for Lighthouse performance and accessibility audits."
          branch: "ai-lighthouse-fixes-${{ github.run_id }}"
